{"hash":"deaa4d8ef101ce2ca2fb50699f3494cb35bd517a","data":{"post":{"title":"Detecting barcode from the browser!!!","content":"<h2 id=\"background\"><a class=\"header-anchor\" href=\"#background\">#</a> Background</h2>\n<p>I have just arranged for my first ever concert that is going to happen in mid-December in Hong Kong. As I was sorting out the logistics for ticket sales, I decided to build a simple system for myself. People can go on the <a href=\"https://stripe.com/en-gb/payments/payment-links\" target=\"_blank\" rel=\"noopener noreferrer\">stripe payment link<OutboundLink/></a> to purchase the ticket. Then a webhook will be triggered which generates an email with a QR code. The QR code then will be scanned for entry on the day of concert at the door. As I was looking for solution for QR code detection, I discovered this beautiful <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Barcode_Detection_API\" target=\"_blank\" rel=\"noopener noreferrer\">Barcode Detection API<OutboundLink/></a></p>\n<p>I didn't see many tutorials about it yet, so I have decided to make a note about my exploration. Hope you will enjoy!</p>\n<h2 id=\"article-synopsis\"><a class=\"header-anchor\" href=\"#article-synopsis\">#</a> Article Synopsis</h2>\n<p>This article will split into 2 parts:</p>\n<ol>\n<li>Getting feed from camera</li>\n<li>Detect barcode from camera feed</li>\n</ol>\n<h2 id=\"part-1-getting-feed-from-camera\"><a class=\"header-anchor\" href=\"#part-1-getting-feed-from-camera\">#</a> Part 1: Getting feed from camera</h2>\n<p>In this section, our goal is to put the camera stream onto the page.</p>\n<p>First, we need a <code>&lt;video&gt;</code> element to show the camera stream.</p>\n<!--beforebegin--><div class=\"language-html extra-class\"><!--afterbegin--><pre v-pre class=\"language-html\"><code><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>video</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stream<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100vw<span class=\"token punctuation\">;</span> <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 100vh<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span> <span class=\"token punctuation\">/></span></span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>Then, we can simply use <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia\" target=\"_blank\" rel=\"noopener noreferrer\"><code>getUserMedia</code><OutboundLink/></a> to grab the media stream; pass that stream directly to the video element.</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> navigator<span class=\"token punctuation\">.</span>mediaDevices<span class=\"token punctuation\">.</span><span class=\"token function\">getUserMedia</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  video<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    facingMode<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> ideal<span class=\"token operator\">:</span> <span class=\"token string\">'environment'</span> <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  audio<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> videoEl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#stream'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nvideoEl<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> videoEl<span class=\"token punctuation\">.</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>Note that, the <code>{ ideal: 'environment' }</code> option is provided so the back camera on a phone is used. Find out more <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/MediaStreamConstraints/video\" target=\"_blank\" rel=\"noopener noreferrer\">here<OutboundLink/></a>.</p>\n<p>With these few lines of code, we capture the camera feed and displayed it on the screen. <a href=\"https://codepen.io/ycmjason/pen/PoKRWpp\" target=\"_blank\" rel=\"noopener noreferrer\">See codepen<OutboundLink/></a>.</p>\n<h2 id=\"part-2-detect-barcode-from-camera-feed\"><a class=\"header-anchor\" href=\"#part-2-detect-barcode-from-camera-feed\">#</a> Part 2: Detect barcode from camera feed</h2>\n<p>The <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Barcode_Detection_API\" target=\"_blank\" rel=\"noopener noreferrer\">barcode detection api<OutboundLink/></a> provides a simple API for barcode detection. All you need is <code>new BarcodeDetector(...)</code> then <code>barcodeDetector.detect(videoElement)</code>.</p>\n<p>So we will add these two lines:</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">/* code from part one */</span>\n\n\n<span class=\"token keyword\">const</span> barcodeDetector <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BarcodeDetector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>formats<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'qr_code'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> barcodes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> barcodeDetector<span class=\"token punctuation\">.</span><span class=\"token function\">detect</span><span class=\"token punctuation\">(</span>videoEl<span class=\"token punctuation\">)</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>Now the barcode detector will be activated at the exact moment the video starts streaming. We probably won't expect to find any QR code at the moment people turn on their camera. So we will need to continuously look at the video stream and call <code>.detect(...)</code> until we got some barcodes.</p>\n<p>In order to do that, we can <code>.detect</code> every X ms until we got some barcodes. Simply use <code>window.setInterval</code> for this.</p>\n<!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token comment\">/* code from part one */</span>\n\n<span class=\"token keyword\">const</span> barcodeDetector <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BarcodeDetector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>formats<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'qr_code'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> barcodes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> barcodeDetector<span class=\"token punctuation\">.</span><span class=\"token function\">detect</span><span class=\"token punctuation\">(</span>videoEl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>barcodes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>barcodes<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">barcode</span> <span class=\"token operator\">=></span> barcode<span class=\"token punctuation\">.</span>rawValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>Now the camera will look for barcode every second! <a href=\"https://codepen.io/ycmjason/pen/rNzdjmP\" target=\"_blank\" rel=\"noopener noreferrer\">See codepen<OutboundLink/></a> and try to load up a QR code to test! Here is an QR code for &quot;hello world&quot;.</p>\n<p><img src=\"https://api.qrserver.com/v1/create-qr-code/?size=250x250&amp;data=hello%20world\" alt=\"QR code for &quot;hello world&quot;\"></p>\n<h2 id=\"end\"><a class=\"header-anchor\" href=\"#end\">#</a> END</h2>\n<p>Final results (<a href=\"https://codepen.io/ycmjason/pen/rNzdjmP\" target=\"_blank\" rel=\"noopener noreferrer\">codepen<OutboundLink/></a>):</p>\n<!--beforebegin--><div class=\"language-html extra-class\"><!--afterbegin--><pre v-pre class=\"language-html\"><code><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>video</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>stream<span class=\"token punctuation\">\"</span></span> <span class=\"token special-attr\"><span class=\"token attr-name\">style</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span><span class=\"token value css language-css\"><span class=\"token property\">width</span><span class=\"token punctuation\">:</span> 100vw<span class=\"token punctuation\">;</span> <span class=\"token property\">height</span><span class=\"token punctuation\">:</span> 100vh<span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">\"</span></span></span><span class=\"token punctuation\">/></span></span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><!--beforebegin--><div class=\"language-js extra-class\"><!--afterbegin--><pre v-pre class=\"language-js\"><code><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">const</span> stream <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> navigator<span class=\"token punctuation\">.</span>mediaDevices<span class=\"token punctuation\">.</span><span class=\"token function\">getUserMedia</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  video<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    facingMode<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      ideal<span class=\"token operator\">:</span> <span class=\"token string\">\"environment\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  audio<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> videoEl <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">querySelector</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"#stream\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nvideoEl<span class=\"token punctuation\">.</span>srcObject <span class=\"token operator\">=</span> stream<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">await</span> videoEl<span class=\"token punctuation\">.</span><span class=\"token function\">play</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> barcodeDetector <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BarcodeDetector</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>formats<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'qr_code'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwindow<span class=\"token punctuation\">.</span><span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> barcodes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> barcodeDetector<span class=\"token punctuation\">.</span><span class=\"token function\">detect</span><span class=\"token punctuation\">(</span>videoEl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>barcodes<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&lt;=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span>barcodes<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">barcode</span> <span class=\"token operator\">=></span> barcode<span class=\"token punctuation\">.</span>rawValue<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<!--beforeend--></div><!--afterend--><p>Happy coding!</p>\n"}},"context":{}}