<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-tag="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>Limit concurrent asynchronous calls - YCM Jason</title><meta name="gridsome:hash" content="79484578e79e16fd5b606f0aa330125a667bf54f"><meta data-vue-tag="ssr" charset="utf-8"><meta data-vue-tag="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-tag="ssr" data-key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-tag="ssr" data-key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-tag="ssr" data-key="description" name="description" content="Jason loves solving problems. And he plays music."><link data-vue-tag="ssr" rel="icon" href="data:,"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.fc1e89df36d8722b28a19d261954e6a2.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.fc1e89df36d8722b28a19d261954e6a2.png"><link data-vue-tag="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.fc1e89df36d8722b28a19d261954e6a2.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.fc1e89df36d8722b28a19d261954e6a2.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.fc1e89df36d8722b28a19d261954e6a2.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.fc1e89df36d8722b28a19d261954e6a2.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.fc1e89df36d8722b28a19d261954e6a2.png"><link data-vue-tag="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.fc1e89df36d8722b28a19d261954e6a2.png"><link rel="preload" href="/assets/css/0.styles.11dff2c8.css" as="style"><link rel="preload" href="/assets/js/app.76e0a5b5.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--dev-to-post-vue.a20627f2.js" as="script"><link rel="prefetch" href="/assets/js/page--node-modules--gridsome--app--pages--404-vue.6d2260cd.js"><link rel="prefetch" href="/assets/js/page--src--pages--articles-vue.11333157.js"><link rel="prefetch" href="/assets/js/page--src--pages--cv-vue.831219f0.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.314436d7.js"><link rel="prefetch" href="/assets/js/vendors~page--src--pages--articles-vue.10fd57b5.js"><link rel="stylesheet" href="/assets/css/0.styles.11dff2c8.css"><noscript data-vue-tag="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="layout"><a href="https://github.com/ycmjason/ycmjason.com" aria-label="View source on GitHub" class="github-corner" data-v-03ac3be2><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" data-v-03ac3be2><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z" data-v-03ac3be2></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" class="octo-arm" style="transform-origin: 130px 106px;" data-v-03ac3be2></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body" data-v-03ac3be2></path></svg></a><header class="header"><strong class="site-name">YCM Jason</strong><nav class="nav"><a href="/" class="nav__link active">Home</a><a href="/articles/" class="nav__link">Articles</a><a href="/cv/" class="nav__link">CV</a><a href="https://github.com/ycmjason" target="_blank" rel="noopener" class="nav__link">Github</a></nav></header><div class="markdown-body"><h1>Limit concurrent asynchronous calls</h1><div><p>Although Javascript is designed to be single threaded, you could still do things concurrently.</p>
<p>For example, we can read multiple files concurrently.</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> readFile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'util'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">promisify</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">readAllFiles</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">paths</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>paths<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">p</span> <span class="token operator">=></span> <span class="token function">readFile</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>However, reading files could be quite computationally expensive; if there are more than 10k paths, you will probably hear the fans on your machine speed up as your machine struggles. Your node server/program will respond significantly slower too as there are 10k+ file reading operations in the OS's thread-pool competing with the node server.</p>
<p>The solution is simple. Simply limit the number of file reading operations in the thread-pool. In another words, limit the number of concurrent calls to <code>readFile</code>.</p>
<p>Let's define a generic function <code>asyncLimit(fn, n)</code> which will return a function that does exactly what <code>fn</code> does, but with the number of concurrent calls to <code>fn</code> limited to <code>n</code>. We will assume <code>fn</code> returns a <code>Promise</code>.</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">asyncLimit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>Since we know that <code>asyncLimit</code> returns a function that does whatever <code>fn</code> does, we first write this out. Note that we don't use arrow function as <code>fn</code> might need the binding to <code>this</code>. Arrow function does not have it's own binding.</p>
<p>If you are not familiar with <code>this</code> in Javascript, read <a href="https://dev.to/ycmjason/let-me-explain-to-you-what-is-this-javascript-44ja" target="_blank" rel="noopener noreferrer">my article<OutboundLink/></a> explaining what is <code>this</code> later. For now, just ignore it.</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">asyncLimit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pendingPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>Since <code>fn</code> returns a <code>Promise</code>, we could keep track of the &quot;process&quot; of each call by keeping the promises they returns. We keep those promises in the list <code>pendingPromises</code>.</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">asyncLimit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pendingPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingPromises<span class="token punctuation">.</span>length <span class="token operator">>=</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>pendingPromises<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>We mark our returning function as <code>async</code>, this enables us to use <code>await</code> in the function. We only want to execute <code>fn</code> only if there are less than <code>n</code> concurrent calls going on. <code>pendingPromises</code> contains all previous promises. So we can just check the <code>pendingPromises.length</code> to find out how many concurrent calls there are.</p>
<p>If <code>pendingPromises.length &gt;= n</code>, we will need to wait until one of the <code>pendingPromises</code> finishes before executing. So we added <code>await Promise.race(pendingPromises)</code>.</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">asyncLimit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pendingPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingPromises<span class="token punctuation">.</span>length <span class="token operator">>=</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>pendingPromises<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> p<span class="token punctuation">;</span>
    pendingPromises <span class="token operator">=</span> pendingPromises<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">pending</span> <span class="token operator">=></span> pending <span class="token operator">!==</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>We want to get rid of the promise in the <code>pendingPromises</code> once they are finished. First we execute <code>fn</code>, and it returns <code>p</code>. Then we add <code>p</code> to the <code>pendingPromises</code>. After this, we can do <code>await p</code>; <code>p</code> will be finished after this line. So we simply <code>filter</code> out <code>p</code> from <code>pendingPromises</code>.</p>
<p>We are almost done. Let's recap what we are doing here:</p>
<p>if <code>pendingPromises.length &lt; n</code></p>
<ol>
<li>we call <code>fn</code> and obtain the promise <code>p</code></li>
<li>push <code>p</code> onto <code>pendingPromises</code></li>
<li>wait <code>p</code> to finish</li>
<li>remove <code>p</code> from <code>pendingPromises</code></li>
<li>return p</li>
</ol>
<p>if <code>pendingPromises.length &gt;= n</code>, we will wait until one of the <code>pendingPromises</code> resolves/rejects before doing the above.</p>
<p>There is one problem with our code tho. Let's consider the following:</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> f <span class="token operator">=</span> <span class="token function">limitAsync</span><span class="token punctuation">(</span>someFunction<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1st call, someFunction returns promise p1</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2nd call, someFunction returns promise p2</span>
<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3rd call, someFunction returns promise p3</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>The first call goes perfectly and <code>pendingPromises.length</code> becomes <code>1</code>.</p>
<p>Since <code>pendingPromises.length &gt;= 1</code>, we know that both 2nd and 3rd call will be calling <code>await Promise.race([p1])</code>. This means that when <code>p1</code> finishes, both 2nd and 3rd calls will both get notified and executes <code>someFunction</code> concurrently.</p>
<p>Put it simple, our code does not make the 3rd call to wait until the 2nd call has finished!</p>
<p>We know that 2nd call will get notified first and resumes from <code>await Promise.race([p1])</code>. 2nd call executes <code>someFunction</code> and pushes its promise to <code>pendingPromises</code>, then it will do <code>await p</code>.</p>
<p>As 2nd call does <code>await p</code>, 3rd call will resume from <code>await Promise.race([p1])</code>. And here is where the problem is. The current implementation allow the 3rd call to execute <code>someFunction</code> and blah blah blah that follows.</p>
<p>But what we want is that the 3rd call would check <code>pendingPromises.length &gt;= n</code> again and do <code>await Promise.race([p2])</code>. To do this, we could simply change <code>if</code> to <code>while</code>.</p>
<p>So the final code would be:</p>
<!--beforebegin--><div class="language-js extra-class"><!--afterbegin--><pre v-pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">asyncLimit</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">fn<span class="token punctuation">,</span> n</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> pendingPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>pendingPromises<span class="token punctuation">.</span>length <span class="token operator">>=</span> n<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span>pendingPromises<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> p <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingPromises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> p<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pendingPromises <span class="token operator">=</span> pendingPromises<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">pending</span> <span class="token operator">=></span> pending <span class="token operator">!==</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> p<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<!--beforeend--></div><!--afterend--><p>Notice that I have added <code>.catch(() =&gt; {})</code> to the <code>Promise.race</code> and <code>await p</code>. This is because we don't care if the promise resolves or rejects, we just wanna know if they are finished.</p>
<p>I have publish this to <a href="https://www.npmjs.com/package/@ycm.jason/async-limit" target="_blank" rel="noopener noreferrer">npm<OutboundLink/></a> if you wish to use. Here is the <a href="https://github.com/ycmjason/asyncLimit" target="_blank" rel="noopener noreferrer">github<OutboundLink/></a> link if you want to see how I added tests for this function.</p>
<p>What do you think? Did you follow the tutorial?</p>
<p>EDIT:</p>
<ul>
<li>removed <code>async</code> for <code>asyncLimit</code>. Thanks to <a href="https://dev.to/benjaminblack" target="_blank" rel="noopener noreferrer">@benjaminblack<OutboundLink/></a></li>
</ul>
</div></div><footer>Copyright © 2021 Jason Yu</footer></div>
    <script>window.__INITIAL_STATE__={"data":{"post":{"title":"Limit concurrent asynchronous calls","content":"\u003Cp\u003EAlthough Javascript is designed to be single threaded, you could still do things concurrently.\u003C\u002Fp\u003E\n\u003Cp\u003EFor example, we can read multiple files concurrently.\u003C\u002Fp\u003E\n\u003C!--beforebegin--\u003E\u003Cdiv class=\"language-js extra-class\"\u003E\u003C!--afterbegin--\u003E\u003Cpre v-pre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E readFile \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Erequire\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E'util'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epromisify\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Erequire\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token string\"\u003E'fs'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003EreadFile\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\n\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"token function-variable function\"\u003EreadAllFiles\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Easync\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Epaths\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Eawait\u003C\u002Fspan\u003E Promise\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eall\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Epaths\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Emap\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Ep\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003EreadFile\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ep\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token string\"\u003E'utf8'\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C!--beforeend--\u003E\u003C\u002Fdiv\u003E\u003C!--afterend--\u003E\u003Cp\u003EHowever, reading files could be quite computationally expensive; if there are more than 10k paths, you will probably hear the fans on your machine speed up as your machine struggles. Your node server\u002Fprogram will respond significantly slower too as there are 10k+ file reading operations in the OS's thread-pool competing with the node server.\u003C\u002Fp\u003E\n\u003Cp\u003EThe solution is simple. Simply limit the number of file reading operations in the thread-pool. In another words, limit the number of concurrent calls to \u003Ccode\u003EreadFile\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003ELet's define a generic function \u003Ccode\u003EasyncLimit(fn, n)\u003C\u002Fcode\u003E which will return a function that does exactly what \u003Ccode\u003Efn\u003C\u002Fcode\u003E does, but with the number of concurrent calls to \u003Ccode\u003Efn\u003C\u002Fcode\u003E limited to \u003Ccode\u003En\u003C\u002Fcode\u003E. We will assume \u003Ccode\u003Efn\u003C\u002Fcode\u003E returns a \u003Ccode\u003EPromise\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003C!--beforebegin--\u003E\u003Cdiv class=\"language-js extra-class\"\u003E\u003C!--afterbegin--\u003E\u003Cpre v-pre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"token function-variable function\"\u003EasyncLimit\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Efn\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E n\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003E\u003Cspan class=\"token operator\"\u003E...\u003C\u002Fspan\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Efn\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eapply\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E args\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C!--beforeend--\u003E\u003C\u002Fdiv\u003E\u003C!--afterend--\u003E\u003Cp\u003ESince we know that \u003Ccode\u003EasyncLimit\u003C\u002Fcode\u003E returns a function that does whatever \u003Ccode\u003Efn\u003C\u002Fcode\u003E does, we first write this out. Note that we don't use arrow function as \u003Ccode\u003Efn\u003C\u002Fcode\u003E might need the binding to \u003Ccode\u003Ethis\u003C\u002Fcode\u003E. Arrow function does not have it's own binding.\u003C\u002Fp\u003E\n\u003Cp\u003EIf you are not familiar with \u003Ccode\u003Ethis\u003C\u002Fcode\u003E in Javascript, read \u003Ca href=\"https:\u002F\u002Fdev.to\u002Fycmjason\u002Flet-me-explain-to-you-what-is-this-javascript-44ja\" target=\"_blank\" rel=\"noopener noreferrer\"\u003Emy article\u003COutboundLink\u002F\u003E\u003C\u002Fa\u003E explaining what is \u003Ccode\u003Ethis\u003C\u002Fcode\u003E later. For now, just ignore it.\u003C\u002Fp\u003E\n\u003C!--beforebegin--\u003E\u003Cdiv class=\"language-js extra-class\"\u003E\u003C!--afterbegin--\u003E\u003Cpre v-pre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"token function-variable function\"\u003EasyncLimit\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Efn\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E n\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E pendingPromises \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003E\u003Cspan class=\"token operator\"\u003E...\u003C\u002Fspan\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E p \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Efn\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eapply\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E args\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    pendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epush\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ep\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E p\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C!--beforeend--\u003E\u003C\u002Fdiv\u003E\u003C!--afterend--\u003E\u003Cp\u003ESince \u003Ccode\u003Efn\u003C\u002Fcode\u003E returns a \u003Ccode\u003EPromise\u003C\u002Fcode\u003E, we could keep track of the &quot;process&quot; of each call by keeping the promises they returns. We keep those promises in the list \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003C!--beforebegin--\u003E\u003Cdiv class=\"language-js extra-class\"\u003E\u003C!--afterbegin--\u003E\u003Cpre v-pre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"token function-variable function\"\u003EasyncLimit\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Efn\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E n\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E pendingPromises \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Easync\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003E\u003Cspan class=\"token operator\"\u003E...\u003C\u002Fspan\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EpendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elength \u003Cspan class=\"token operator\"\u003E\u003E=\u003C\u002Fspan\u003E n\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Eawait\u003C\u002Fspan\u003E Promise\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Erace\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EpendingPromises\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E p \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Efn\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eapply\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E args\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    pendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epush\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ep\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E p\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C!--beforeend--\u003E\u003C\u002Fdiv\u003E\u003C!--afterend--\u003E\u003Cp\u003EWe mark our returning function as \u003Ccode\u003Easync\u003C\u002Fcode\u003E, this enables us to use \u003Ccode\u003Eawait\u003C\u002Fcode\u003E in the function. We only want to execute \u003Ccode\u003Efn\u003C\u002Fcode\u003E only if there are less than \u003Ccode\u003En\u003C\u002Fcode\u003E concurrent calls going on. \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E contains all previous promises. So we can just check the \u003Ccode\u003EpendingPromises.length\u003C\u002Fcode\u003E to find out how many concurrent calls there are.\u003C\u002Fp\u003E\n\u003Cp\u003EIf \u003Ccode\u003EpendingPromises.length &gt;= n\u003C\u002Fcode\u003E, we will need to wait until one of the \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E finishes before executing. So we added \u003Ccode\u003Eawait Promise.race(pendingPromises)\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003C!--beforebegin--\u003E\u003Cdiv class=\"language-js extra-class\"\u003E\u003C!--afterbegin--\u003E\u003Cpre v-pre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"token function-variable function\"\u003EasyncLimit\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Efn\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E n\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E pendingPromises \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Easync\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003E\u003Cspan class=\"token operator\"\u003E...\u003C\u002Fspan\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Eif\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EpendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elength \u003Cspan class=\"token operator\"\u003E\u003E=\u003C\u002Fspan\u003E n\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Eawait\u003C\u002Fspan\u003E Promise\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Erace\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EpendingPromises\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E p \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Efn\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eapply\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E args\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    pendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epush\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ep\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Eawait\u003C\u002Fspan\u003E p\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    pendingPromises \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E pendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Efilter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Epending\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E pending \u003Cspan class=\"token operator\"\u003E!==\u003C\u002Fspan\u003E p\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E p\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C!--beforeend--\u003E\u003C\u002Fdiv\u003E\u003C!--afterend--\u003E\u003Cp\u003EWe want to get rid of the promise in the \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E once they are finished. First we execute \u003Ccode\u003Efn\u003C\u002Fcode\u003E, and it returns \u003Ccode\u003Ep\u003C\u002Fcode\u003E. Then we add \u003Ccode\u003Ep\u003C\u002Fcode\u003E to the \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E. After this, we can do \u003Ccode\u003Eawait p\u003C\u002Fcode\u003E; \u003Ccode\u003Ep\u003C\u002Fcode\u003E will be finished after this line. So we simply \u003Ccode\u003Efilter\u003C\u002Fcode\u003E out \u003Ccode\u003Ep\u003C\u002Fcode\u003E from \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003EWe are almost done. Let's recap what we are doing here:\u003C\u002Fp\u003E\n\u003Cp\u003Eif \u003Ccode\u003EpendingPromises.length &lt; n\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Col\u003E\n\u003Cli\u003Ewe call \u003Ccode\u003Efn\u003C\u002Fcode\u003E and obtain the promise \u003Ccode\u003Ep\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\n\u003Cli\u003Epush \u003Ccode\u003Ep\u003C\u002Fcode\u003E onto \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\n\u003Cli\u003Ewait \u003Ccode\u003Ep\u003C\u002Fcode\u003E to finish\u003C\u002Fli\u003E\n\u003Cli\u003Eremove \u003Ccode\u003Ep\u003C\u002Fcode\u003E from \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\n\u003Cli\u003Ereturn p\u003C\u002Fli\u003E\n\u003C\u002Fol\u003E\n\u003Cp\u003Eif \u003Ccode\u003EpendingPromises.length &gt;= n\u003C\u002Fcode\u003E, we will wait until one of the \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E resolves\u002Frejects before doing the above.\u003C\u002Fp\u003E\n\u003Cp\u003EThere is one problem with our code tho. Let's consider the following:\u003C\u002Fp\u003E\n\u003C!--beforebegin--\u003E\u003Cdiv class=\"language-js extra-class\"\u003E\u003C!--afterbegin--\u003E\u003Cpre v-pre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E f \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003ElimitAsync\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EsomeFunction\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E \u003Cspan class=\"token number\"\u003E1\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ef\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F\u002F 1st call, someFunction returns promise p1\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ef\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F\u002F 2nd call, someFunction returns promise p2\u003C\u002Fspan\u003E\n\u003Cspan class=\"token function\"\u003Ef\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E \u003Cspan class=\"token comment\"\u003E\u002F\u002F 3rd call, someFunction returns promise p3\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C!--beforeend--\u003E\u003C\u002Fdiv\u003E\u003C!--afterend--\u003E\u003Cp\u003EThe first call goes perfectly and \u003Ccode\u003EpendingPromises.length\u003C\u002Fcode\u003E becomes \u003Ccode\u003E1\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003ESince \u003Ccode\u003EpendingPromises.length &gt;= 1\u003C\u002Fcode\u003E, we know that both 2nd and 3rd call will be calling \u003Ccode\u003Eawait Promise.race([p1])\u003C\u002Fcode\u003E. This means that when \u003Ccode\u003Ep1\u003C\u002Fcode\u003E finishes, both 2nd and 3rd calls will both get notified and executes \u003Ccode\u003EsomeFunction\u003C\u002Fcode\u003E concurrently.\u003C\u002Fp\u003E\n\u003Cp\u003EPut it simple, our code does not make the 3rd call to wait until the 2nd call has finished!\u003C\u002Fp\u003E\n\u003Cp\u003EWe know that 2nd call will get notified first and resumes from \u003Ccode\u003Eawait Promise.race([p1])\u003C\u002Fcode\u003E. 2nd call executes \u003Ccode\u003EsomeFunction\u003C\u002Fcode\u003E and pushes its promise to \u003Ccode\u003EpendingPromises\u003C\u002Fcode\u003E, then it will do \u003Ccode\u003Eawait p\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003EAs 2nd call does \u003Ccode\u003Eawait p\u003C\u002Fcode\u003E, 3rd call will resume from \u003Ccode\u003Eawait Promise.race([p1])\u003C\u002Fcode\u003E. And here is where the problem is. The current implementation allow the 3rd call to execute \u003Ccode\u003EsomeFunction\u003C\u002Fcode\u003E and blah blah blah that follows.\u003C\u002Fp\u003E\n\u003Cp\u003EBut what we want is that the 3rd call would check \u003Ccode\u003EpendingPromises.length &gt;= n\u003C\u002Fcode\u003E again and do \u003Ccode\u003Eawait Promise.race([p2])\u003C\u002Fcode\u003E. To do this, we could simply change \u003Ccode\u003Eif\u003C\u002Fcode\u003E to \u003Ccode\u003Ewhile\u003C\u002Fcode\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003ESo the final code would be:\u003C\u002Fp\u003E\n\u003C!--beforebegin--\u003E\u003Cdiv class=\"language-js extra-class\"\u003E\u003C!--afterbegin--\u003E\u003Cpre v-pre class=\"language-js\"\u003E\u003Ccode\u003E\u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E \u003Cspan class=\"token function-variable function\"\u003EasyncLimit\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Efn\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E n\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Elet\u003C\u002Fspan\u003E pendingPromises \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E[\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E]\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Easync\u003C\u002Fspan\u003E \u003Cspan class=\"token keyword\"\u003Efunction\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003E\u003Cspan class=\"token operator\"\u003E...\u003C\u002Fspan\u003Eargs\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ewhile\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EpendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003Elength \u003Cspan class=\"token operator\"\u003E\u003E=\u003C\u002Fspan\u003E n\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\n      \u003Cspan class=\"token keyword\"\u003Eawait\u003C\u002Fspan\u003E Promise\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Erace\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003EpendingPromises\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecatch\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\n\n    \u003Cspan class=\"token keyword\"\u003Econst\u003C\u002Fspan\u003E p \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"token function\"\u003Efn\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Eapply\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token keyword\"\u003Ethis\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E,\u003C\u002Fspan\u003E args\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    pendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Epush\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003Ep\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Eawait\u003C\u002Fspan\u003E p\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Ecatch\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E \u003Cspan class=\"token punctuation\"\u003E{\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    pendingPromises \u003Cspan class=\"token operator\"\u003E=\u003C\u002Fspan\u003E pendingPromises\u003Cspan class=\"token punctuation\"\u003E.\u003C\u002Fspan\u003E\u003Cspan class=\"token function\"\u003Efilter\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E(\u003C\u002Fspan\u003E\u003Cspan class=\"token parameter\"\u003Epending\u003C\u002Fspan\u003E \u003Cspan class=\"token operator\"\u003E=\u003E\u003C\u002Fspan\u003E pending \u003Cspan class=\"token operator\"\u003E!==\u003C\u002Fspan\u003E p\u003Cspan class=\"token punctuation\"\u003E)\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"token keyword\"\u003Ereturn\u003C\u002Fspan\u003E p\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n  \u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"token punctuation\"\u003E}\u003C\u002Fspan\u003E\u003Cspan class=\"token punctuation\"\u003E;\u003C\u002Fspan\u003E\n\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C!--beforeend--\u003E\u003C\u002Fdiv\u003E\u003C!--afterend--\u003E\u003Cp\u003ENotice that I have added \u003Ccode\u003E.catch(() =&gt; {})\u003C\u002Fcode\u003E to the \u003Ccode\u003EPromise.race\u003C\u002Fcode\u003E and \u003Ccode\u003Eawait p\u003C\u002Fcode\u003E. This is because we don't care if the promise resolves or rejects, we just wanna know if they are finished.\u003C\u002Fp\u003E\n\u003Cp\u003EI have publish this to \u003Ca href=\"https:\u002F\u002Fwww.npmjs.com\u002Fpackage\u002F@ycm.jason\u002Fasync-limit\" target=\"_blank\" rel=\"noopener noreferrer\"\u003Enpm\u003COutboundLink\u002F\u003E\u003C\u002Fa\u003E if you wish to use. Here is the \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fycmjason\u002FasyncLimit\" target=\"_blank\" rel=\"noopener noreferrer\"\u003Egithub\u003COutboundLink\u002F\u003E\u003C\u002Fa\u003E link if you want to see how I added tests for this function.\u003C\u002Fp\u003E\n\u003Cp\u003EWhat do you think? Did you follow the tutorial?\u003C\u002Fp\u003E\n\u003Cp\u003EEDIT:\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003Eremoved \u003Ccode\u003Easync\u003C\u002Fcode\u003E for \u003Ccode\u003EasyncLimit\u003C\u002Fcode\u003E. Thanks to \u003Ca href=\"https:\u002F\u002Fdev.to\u002Fbenjaminblack\" target=\"_blank\" rel=\"noopener noreferrer\"\u003E@benjaminblack\u003COutboundLink\u002F\u003E\u003C\u002Fa\u003E\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n"}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.76e0a5b5.js" defer></script><script src="/assets/js/page--src--templates--dev-to-post-vue.a20627f2.js" defer></script>
  </body>
</html>
